
%global __jar_repack 0

Summary:	SpagoBI 3rd party dependencies
Name:		@PACKAGE_NAME@
Version:	@PACKAGE_RPM_VERSION@
Release:	@PACKAGE_RPM_RELEASE@%{?release_suffix}%{?dist}
License:	@PACKAGE_LICENSE@
URL:		http://www.ovirt.org
Source:		@PACKAGE_NAME@-@PACKAGE_VERSION@-@PACKAGE_RPM_RELEASE@.tar.gz
Group:		Virtualization/Management

BuildArch:	noarch

BuildRequires:	tar
BuildRequires:	unzip
BuildRequires:	curl

%if 0%{?rhel}
BuildRequires: maven-local
%endif
%if 0%{?fedora}
BuildRequires: javapackages-local

#com.sun.jersey:jersey-grizzly2
BuildRequires: mvn(org.glassfish.grizzly:grizzly-http)

# org.jboss.resteasy:resteasy-jaxrs
BuildRequires: mvn(org.apache.httpcomponents:httpclient)
BuildRequires: mvn(org.jboss.resteasy:jaxrs-api)
BuildRequires: mvn(commons-httpclient:commons-httpclient)
BuildRequires: mvn(javax.annotation:jsr250-api)
BuildRequires: mvn(net.jcip:jcip-annotations)
BuildRequires: mvn(commons-io:commons-io)
BuildRequires: mvn(org.scannotation:scannotation)

# com.xebialabs.restito:restito
BuildRequires: mvn(org.apache.mina:mina-core)
BuildRequires: mvn(org.glassfish.grizzly:grizzly-http-server)
BuildRequires: mvn(org.mockito:mockito-core)
BuildRequires: mvn(com.jayway.jsonpath:json-path)
BuildRequires: mvn(junit:junit)

# it.eng.spago:spago-core
BuildRequires: mvn(avalon-framework:avalon-framework)
BuildRequires: mvn(com.jamonapi:jamon)
BuildRequires: mvn(commons-dbcp:commons-dbcp)
BuildRequires: mvn(commons-validator:commons-validator)
BuildRequires: mvn(javax.mail:mail)
BuildRequires: mvn(javax.transaction:jta)
BuildRequires: mvn(oro:oro)

BuildRequires: mvn(org.apache:apache:pom:)

# commons-betwixt:commons-betwixt
BuildRequires: mvn(commons-beanutils:commons-beanutils-core)
BuildRequires: mvn(commons-digester:commons-digester)

# org.cometd.java:cometd-java-common
BuildRequires: mvn(org.eclipse.jetty:jetty-util-ajax)

# org.cometd.java:cometd-java-server
BuildRequires: mvn(org.eclipse.jetty:jetty-jmx)

# jgrapht-0.9.1.pom
BuildRequires: sonatype-oss-parent
%endif

%description
SpagoBI 3rd party dependencies

%prep
%setup -q -n %{name}-@PACKAGE_VERSION@

# Parents first
%mvn_artifact downloads/cometd-project-3.0.5.pom
my_already_installed=(downloads/cometd-project-3.0.5.pom)

%mvn_artifact downloads/jug-2.0.0.pom downloads/jug-2.0.0-lgpl.jar
my_already_installed+=(downloads/jug-2.0.0.pom)

for artifact in $(find downloads -name "*parent*.pom")
do
    if ! [[ " ${my_already_installed[@]} " =~ " ${artifact} " ]]; then
        %mvn_artifact ${artifact}
        my_already_installed+=(${artifact})
    fi
done

for artifact in $(find downloads -name "*.pom")
do
if [ ! -e ${artifact/.pom/.jar} ]
then
    if ! [[ " ${my_already_installed[@]} " =~ " ${artifact} " ]]; then
        %mvn_artifact ${artifact}
        my_already_installed+=(${artifact})
    fi
fi
done

for artifact in $(find downloads -name "*.pom")
do
if [ -e ${artifact/.pom/.jar} ]
then
    if ! [[ " ${my_already_installed[@]} " =~ " ${artifact} " ]]; then
        %mvn_artifact ${artifact} ${artifact/.pom/.jar}
        my_already_installed+=(${artifact})
    fi
fi
done

%mvn_alias opensymphony:quartz org.opensymphony.quartz:quartz

%mvn_alias org.safehaus.jug:jug:2.0.0 org.safehaus.jug:jug::lgpl:2.0.0

%build
make OFFLINE=1 %{?_smp_mflags}

# _repack_broken_jar <jar file> <hash> <conf file>
function _repack_broken_jar() {
    local jarfile="${1}"
    local oldhash="${2}"
    local conf="${3}"
    mkdir tmp
    pushd tmp
        jar xvf ../downloads/${jarfile}
        jar cvf ../downloads/${jarfile} *
    popd
    rm -rf tmp
    newhash="$(sha1sum downloads/${jarfile}  | awk '{print $1}' )"
    sed -i "s:${oldhash}:${newhash}:" conf.d/${conf}
}

#{ com.liferay.portal:portal-client:jar:5.2.3
# workaround for duplicate entry: com/liferay/client/soap/portal/service/http/deploy.wsdd
_repack_broken_jar portal-client-5.2.3.jar 20ba2461ec270d4e4d6e9a9fde2cc39aa8f0b60e portal-client.conf
#}

#{ org.openoffice:unoil:jar:3.2.1
# workaround for invalid entry compressed size (expected 640 but got 638 bytes)
_repack_broken_jar unoil-3.2.1.jar 3fe6ae6fb39d7404229bf75ae5f56bf1827fa3c9 unoil.conf
#}

#{ org.openoffice:ridl:jar:3.2.1
# workaround for invalid entry compressed size (expected 5592 but got 5558 bytes)
_repack_broken_jar ridl-3.2.1.jar c2383e8c2ae1e91e9bf9d115585d15f6806249ea ridl.conf
#}

#{ org.openoffice:jurt:jar:3.2.1
# workaround for invalid entry compressed size (expected 7470 but got 7456 bytes)
_repack_broken_jar jurt-3.2.1.jar bcc6e74d8ff0760799ae8bca67b5657091606d0e jurt.conf
#}

#{ org.openoffice:juh:jar:3.2.1
# workaround for invalid entry compressed size (expected 6510 but got 6491 bytes)
_repack_broken_jar juh-3.2.1.jar 8596138f58b984196ad4b69d03de534eda4f23af juh.conf
#}


%install
rm -rf "%{buildroot}"
make %{?_smp_mflags} OFFLINE=1 install DESTDIR="%{buildroot}" JAVADIR="%{_javadir}" POMDIR="%{_mavenpomdir}"
%mvn_install

%files
%doc COPYING
%doc COPYING.csv
%doc ChangeLog
%{_javadir}/%{name}/
%if 0%{?fedora}
%{_jnidir}/%{name}/
%{_mavenpomdir}/%{name}/
%{_datadir}/maven-metadata/*
%endif
%if 0%{?rhel}
%{_mavenpomdir}/*
%{_mavendepmapfragdir}/*
%endif

%changelog
* Mon Jan 25 2016 Sandro Bonazzola <sbonazzo@redhat.com> - 5.2.0-1
- Initial packaging
